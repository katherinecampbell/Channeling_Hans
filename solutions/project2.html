<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script type="text/javascript" src="./d3/d3.v4.js" charset="utf-8"></script>
<!-- Example based on http://bl.ocks.org/mbostock/3887118 -->
<!-- Tooltip example from http://www.d3noob.org/2013/01/adding-tooltips-to-d3js-graph.html -->
<style type="text/css">
		.axis path,
		.axis line {
		    fill: none;
		    stroke: black;
		    shape-rendering: crispEdges;
		}
		
		.axis text {
		    font-family: sans-serif;
		    font-size: 11px;
		}	
    
    .tooltip {
  position: absolute;
  width: 200px;
  height: 28px;
  pointer-events: none;
}
	</style>
    </head>
<body>
 
<h3 id = "year_header">Year: </h3>
    
<script>
    
//global data variable
var dataset;

//margins
var margin = {top: 20, right: 20, bottom: 25, left: 25};

//width and height    
var outer_width = 800;
var outer_height = 600;
var svg_width = outer_width - margin.left - margin.right;
var svg_height = outer_height - margin.top - margin.bottom;


// The year to display
display_year = 2006;

// function that filters data by year
function yearFilter(value){
	return (value.Year == display_year)
}
    
//set up x
var xScale = d3.scaleLinear()
    .range([0, svg_width]) //value of display
        
var xAxis = d3.axisBottom().scale(xScale);

// setup y
var yScale = d3.scaleLinear()
    .range([svg_height,0])
        
var yAxis = d3.axisLeft().scale(yScale);
    
//set up fill color for each region
var colorValue = function(d) { return d.Region;},
    color = d3.scaleOrdinal(d3.schemeCategory10);
 
// add canvas to page with margin transfer
var svg = d3.select("body").append("svg")
    .attr("width", svg_width + margin.left + margin.right)
    .attr("height", svg_height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");    
    
// add the tooltip area to the webpage
var tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);
    
function generateVis(){   
    
    // Filter the data to only include the current year
	var filtered_dataset = dataset.filter(yearFilter);

    // PERFORM DATA JOIN
    //make circless
    var circles = svg.selectAll("circle")
        .data(filtered_dataset, function key(d) {return d.Country;
        });
                                                    
   // Update the display of existing elements to match new data
  	circles
        .attr("cy", function(d,i) { 
		   		return yScale(d.LifeExp);
		  })
        .attr("cx", function(d, i) {
		   		return xScale(d.GDP);
		   })
        .transition()
        .attr("r", 5)
        .style("fill", function(d) {return color(colorValue(d));
        }) 

    
    //ENTER SELECTION
    circles
        .enter().append("circle")
        .attr("r", 5)
        .attr("cx", function (d,i){return xScale(d.GDP);})
        .attr("cy", function(d, i){return yScale(d.LifeExp);})
        .style("fill", function(d) { return color(colorValue(d));}) 
        
        .on("mouseover", function(d) {
          
        tooltip
            .transition()
            .duration(200)
            .style("opacity", .9);
            
        tooltip.html(d["Country"])
            .style("left", (d3.event.pageX + 5) + "px")
            .style("top", (d3.event.pageY - 25) + "px");
      })
    
        .on("mouseout", function(d) {
          tooltip.transition()
              .duration(500)
              .style("opacity", 0);
      });

/******** HANDLE EXIT SELECTION ************/
	// Remove bars that not longer have a matching data eleement
	circles.exit().remove();

    // Set the year label
	d3.select("#year_header").text("Year: " + display_year)
    }    
    
    // load data
    d3.csv("data/Gapminder_small.csv", function(error, data) {

    // handle any data loading errors
        if(error){
            console.log("Something went wrong");
            console.log(error);}
        
        else{
            console.log("Data Loaded");
            
            // Assign  the data object loaded to the global dataset variable
            dataset = data;
                    
            // Set the domains of the x and y scales using the data
			var max_life = d3.max(dataset, function(d) { return d.LifeExp;} ) +10;
                   
            var min_life = d3.min(dataset, function(d){return d.LifeExp;}) - 10;
                    
			var max_gdp = d3.max(dataset, function(d) { return +d.GDP;}) + 5000;
                         
			var min_gdp = d3.min(dataset, function(d) { return d.GDP;} ) - 10000;
		
			xScale.domain([min_gdp, max_gdp]);
			yScale.domain([min_life, max_life]);

			// Create the x-axis
			svg.append("g")
				.attr("class", "axis")
				.attr("id", "x-axis")
				.attr("transform", "translate(0," + svg_height + ")")
				svg.select("#x-axis").call(xAxis);
				
			// Create the y axis
			svg.append("g")
				.attr("class", "axis")
				.attr("id", "y-axis")
                svg.select("#y-axis").call(yAxis)
				    .append("text")
				    .attr("y", 6)
				    .attr("dy", ".71em")
				    .style("text-anchor", "end")
				    .text("Life Expectancy");
		
            // Generate the visualisation
            generateVis();
                
            // Set up an interval callback to iterate through the avialble years
            setInterval(function() {
			display_year = display_year + 1;
			if(display_year > 2012){
				display_year = 2006;
			}
		  	generateVis();
		}, 2500);
	}   
});

 
</script>
</body>
</html>